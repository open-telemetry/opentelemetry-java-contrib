#!/usr/bin/env bash
#MISE description="Lint links in modified files"

set -e

#USAGE flag "--base <base>" help="base branch to compare against" default="origin/main"
#USAGE flag "--head <head>" help="head branch to compare against" default="HEAD"

merge_base=$(git merge-base "$usage_base" HEAD)
# Using lychee's default extension filter here to match when it runs against all files
# Note: --diff-filter=d filters out deleted files
modified_files=$(git diff --name-only --diff-filter=d "$merge_base"..."$usage_head" \
                  | grep -E '\.(md|mkd|mdx|mdown|mdwn|mkdn|mkdown|markdown|html|htm|txt)$' \
                  | tr '\n' ' ' || true)

# Check if lychee config was modified
config_modified=$(git diff --name-only "$merge_base"..."$usage_head" \
                  | grep -E '^(\.github/config/lychee\.toml|mise\.toml)$' || true)

if [ -z "$modified_files" ] && [ -z "$config_modified" ] ; then
  echo "No modified files and no config changes, skipping link linting."
  exit 0
fi

mise run lint-links "$modified_files"
