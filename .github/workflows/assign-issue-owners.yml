---
name: Assign issue owners

on:
  issues:
    types: [labeled]

permissions:
  contents: read

jobs:
  assign-owners:
    permissions:
      contents: read
      issues: write
    runs-on: ubuntu-latest
    if: startsWith(github.event.label.name, 'component:')
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0

      - name: Install yaml dependency used below
        run: npm install yaml@2.8.1 --integrity=sha512-lcYcMxX2PO9XMGvAJkJ3OsNMw+/7FKes7/hgerGUYWIoWu5j/+YQqcZr5JnPZWzOsEBgMbSbiSTn/dv/69Mkpw==

      - name: Parse component label and assign owners
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            const { parse } = require('yaml');

            // Extract component name from label
            const labelName = context.payload.label.name;

            if (!labelName.startsWith('component:')) {
              core.setFailed('Label does not match expected pattern');
              return;
            }

            const componentName = labelName.replace('component:', '');
            console.log(`Processing component: ${componentName}`);

            // Read and parse component_owners.yml
            const yamlContent = fs.readFileSync('.github/component_owners.yml', 'utf8');
            const data = parse(yamlContent);

            if (!data || !data.components) {
              core.setFailed('Invalid component_owners.yml structure');
              return;
            }

            const components = data.components;

            if (!(componentName in components)) {
              core.setFailed(`Component '${componentName}' not found in component_owners.yml`);
              return;
            }

            const owners = components[componentName];

            if (!owners || owners.length === 0) {
              core.setFailed(`No owners found for component '${componentName}'`);
              return;
            }

            console.log(`Found owners: ${owners.join(', ')}`);

            // Assign the issue to the owners
            const issueNumber = context.payload.issue.number;

            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              assignees: owners
            });

            console.log(`Successfully assigned issue #${issueNumber} to ${owners.join(', ')}`);
